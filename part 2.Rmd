---
title: "Untitled"
author: "Машка"
date: '28 июня 2016 г '
output: html_document
---
---
title: "Интерактивная визуализация данных на карте России."
author: "Силкина Мария"
date: "26 июня 2016 г."
output: html_document
lang: russian
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## 


## Отражение динамики на интерактивной карте

Попробуем отразить динамику какого-нибудь фактора на карте России. Например, покажем, сколько новых станций метро было построено в России в период с 2000-ого по 2016 года. 

Для этого нам понадобятся пакет **plotly**, а также данные о постройке метро, которые можно найти на [википедии](https://ru.wikipedia.org/wiki/%D0%A1%D0%BF%D0%B8%D1%81%D0%BE%D0%BA_%D1%81%D1%82%D0%B0%D0%BD%D1%86%D0%B8%D0%B9_%D0%BC%D0%B5%D1%82%D1%80%D0%BE%D0%BF%D0%BE%D0%BB%D0%B8%D1%82%D0%B5%D0%BD%D0%BE%D0%B2_%D0%A0%D0%BE%D1%81%D1%81%D0%B8%D0%B8). 

Готовый файл с данными в формате csv лежит [тут](https://github.com/Evanholf/map) и называется **apinfo.csv**.

```{r libraries, message=FALSE}
library(plotly)

df2 <- read.csv("https://raw.githubusercontent.com/Evanholf/map/master/apinfo.csv", stringsAsFactors=FALSE, encoding ="UTF-8")

g <- list(scope = 'europe', showframe=F, showland = T, landcolor = toRGB("lemonchiffon"), showcountries = T, subunitcolor = toRGB("white"))
```

Итак, мы загрузили файл и присвоили переменной **g** факторные значения, где **scope** - материк, который мы хотим видеть на карте. 

Наши данные выглядят следующим образом:

```{r csv, message=FALSE}
df2[ c(1:6) ,]
```

Введем переменную **years**, которая будет считать имеющиеся года данных. Далее присвоим каждому уникальному году свой номер. Теперь каждому года соответствует определенный номер, который мы занесем в таблицу с данными
```{r sort, message=FALSE}
yrs <- unique(df2$year)
yrs <- sort(yrs)
id <- seq_along(yrs)

df3 <- data.frame(
  year = yrs,
  id = id
)
df2$id <- as.integer(factor(df2$year))  #заносим id в новый столбец таблицы
df2<-df2[order(df2$year, df2$id), ] #сортируем последний столбец по возрастанию

```

Теперь можно перейти к характеристикам карты: <br>

<\br>

```{r sort, message=FALSE}
p <- plot_ly(data=df2, type = 'scattergeo', lon = lon, lat = lat, group = year,
             geo = paste0("geo", id), showlegend = F, text=X.U.FEFF.name,
             marker = list(color = toRGB("blue"), opacity = 0.5)) %>%
  add_trace(lon = 42, lat = 30, mode = 'text', group = year, type = 'scattergeo', showlegend = F,
            geo = paste0("geo", id), text = year, data = df3) %>%
  layout(title = '<b> Новые станции метро </b>',
         geo = g,
         autosize = T,
         width = 800,
         height = 800,
         hovermode = T)

```



?plot_ly

subplot(p, nrows = 5)


?subplot
?paste0




Для начала нанесем на карту Москвы точки, отображающие геоположения ветеринарных учреждений. Для этого нам понадобятся две основные вещи: 

1. **geojson**-файл Москвы, который можно найти в Интернете. Например, на сайте [GIS-LAB](http://gis-lab.info/qa/moscow-atd.html) (нам понадобятся административные округа).

2. Геоданные нужных нам учреждений. Последние возьмем с [Портала Открытых данных Москвы](http://data.mos.ru/), где их можно получить, скачивая вручную, либо через API. Там даже есть изображение доступных данных на [карте](http://atlas.mos.ru/?lang=ru&z=2&ll=37.936117614208726%2C55.74434070349103&l=6854).

Перейдем к написанию кода. Во-первых, необходимо подключить нужные библиотеки и устанавливаем недостающие пакеты. Для изображения карты нам понадобится пакет **highcharter**.

```{r libraries, message=FALSE}
library("dplyr")
library("readr")
library("httr")
library("rvest")
library("geojsonio")
library("rgdal")
library("highcharter")
library("jsonlite")
library("magrittr")
```

Теперь скачиваем карту Москвы в формате geojson и сами геоданные Ветеринарных учреждений. С помощью пакета highcharter преобразуем их в карту.

```{r map, echo=TRUE, message=FALSE}
map <- geojson_read("C:/Users/Hp/Desktop/Интерактивная карта России/files/ao.geojson")
animaljson2 <- geojson_read("C:/Users/Hp/Desktop/Интерактивная карта России/files/anima.json")

highchart(type = "map") %>% 
  hc_title(text = "<b> Ветеринарные учреждения </b>") %>% 
  hc_add_series(mapData = map, showInLegend = FALSE,
                nullColor = "lightblue") %>% 
  hc_add_series(data = animaljson2, type = "mappoint", dataLabels = list(enabled = FALSE),
                name = "Ветеринарное учреждение", color = "steelblue
",
                tooltip = list(pointFormat = "<strong>{point.properties.name}: </strong> <br> 
                               {point.properties.address}" )) %>% 
  hc_mapNavigation(enabled = TRUE) %>% 
  hc_add_theme(hc_theme_sandsignika())

```

